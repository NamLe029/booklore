<div class="settings-card">
  <div class="section-header">
    <div class="section-header-row">
      <div class="section-header-text">
        <h3 class="section-title">
          <i class="pi pi-server"></i>
          Email Providers
        </h3>
        <p class="section-description">
          Configure email-sending services like Gmail, Outlook, or custom SMTP servers. The default provider is used for 'Quick Book Send' in the Book Card menu.
        </p>
      </div>
      <p-button
        icon="pi pi-plus"
        label="Add Provider"
        severity="success"
        size="small"
        [outlined]="true"
        (onClick)="openCreateProviderDialog()">
      </p-button>
    </div>
  </div>

  <div class="section-body">
    @if (emailProviders.length === 0) {
      <div class="empty-state">
        <i class="pi pi-envelope"></i>
        <p class="empty-title">No email providers configured</p>
        <p class="empty-subtitle">Create your first email provider to start sending books</p>
      </div>
    } @else {
      <div class="providers-list">
        @for (provider of emailProviders; track provider.id) {
          <div class="provider-item" [class.is-default]="provider.id === defaultProviderId">
            <div class="provider-header">
              <div class="provider-info">
                <div class="provider-name-row">
                  <p-radioButton
                    name="defaultProvider"
                    [value]="provider.id"
                    [(ngModel)]="defaultProviderId"
                    (onClick)="setDefaultProvider(provider)">
                  </p-radioButton>
                  @if (provider.isEditing) {
                    <input type="text" pInputText [(ngModel)]="provider.name" placeholder="Provider name" class="name-input"/>
                  } @else {
                    <span class="provider-name">{{ provider.name }}</span>
                    @if (provider.shared) {
                      <span class="shared-badge" pTooltip="Shared with all users">
                        <i class="pi pi-share-alt"></i>
                      </span>
                    }
                    @if (provider.id === defaultProviderId) {
                      <span class="default-badge">Default</span>
                    }
                  }
                </div>
              </div>
              <div class="provider-actions">
                @if (!provider.isEditing) {
                  <p-button
                    [icon]="canModifyProvider(provider) ? 'pi pi-pencil' : 'pi pi-lock'"
                    [severity]="canModifyProvider(provider) ? 'info' : 'secondary'"
                    size="small"
                    [outlined]="true"
                    [rounded]="true"
                    [disabled]="!canModifyProvider(provider)"
                    (onClick)="canModifyProvider(provider) && toggleEdit(provider)"
                    [pTooltip]="canModifyProvider(provider) ? 'Edit provider' : 'Cannot edit shared provider'"
                    tooltipPosition="left">
                  </p-button>
                  <p-button
                    [icon]="canModifyProvider(provider) ? 'pi pi-trash' : 'pi pi-lock'"
                    [severity]="canModifyProvider(provider) ? 'danger' : 'secondary'"
                    size="small"
                    [outlined]="true"
                    [rounded]="true"
                    [disabled]="!canModifyProvider(provider)"
                    (onClick)="canModifyProvider(provider) && deleteProvider(provider)"
                    [pTooltip]="canModifyProvider(provider) ? 'Delete provider' : 'Cannot delete shared provider'"
                    tooltipPosition="left">
                  </p-button>
                } @else {
                  <p-button
                    icon="pi pi-check"
                    severity="success"
                    size="small"
                    [outlined]="true"
                    [rounded]="true"
                    (onClick)="saveProvider(provider)"
                    pTooltip="Save changes">
                  </p-button>
                  <p-button
                    icon="pi pi-times"
                    severity="secondary"
                    size="small"
                    [outlined]="true"
                    [rounded]="true"
                    (onClick)="toggleEdit(provider)"
                    pTooltip="Cancel">
                  </p-button>
                }
              </div>
            </div>

            <div class="provider-details">
              <div class="detail-grid">
                <div class="detail-item">
                  <label class="detail-label">
                    <i class="pi pi-server"></i>
                    Host
                  </label>
                  @if (provider.isEditing) {
                    <input type="text" pInputText [(ngModel)]="provider.host" placeholder="smtp.example.com"/>
                  } @else {
                    <span class="detail-value">{{ provider.host }}</span>
                  }
                </div>

                <div class="detail-item">
                  <label class="detail-label">
                    <i class="pi pi-link"></i>
                    Port
                  </label>
                  @if (provider.isEditing) {
                    <input type="number" pInputText [(ngModel)]="provider.port" placeholder="587"/>
                  } @else {
                    <span class="detail-value">{{ provider.port }}</span>
                  }
                </div>

                <div class="detail-item">
                  <label class="detail-label">
                    <i class="pi pi-user"></i>
                    Username
                  </label>
                  @if (provider.isEditing) {
                    <input type="text" pInputText [(ngModel)]="provider.username" placeholder="user@example.com"/>
                  } @else {
                    <span class="detail-value">{{ provider.username }}</span>
                  }
                </div>

                <div class="detail-item">
                  <label class="detail-label">
                    <i class="pi pi-lock"></i>
                    Password
                  </label>
                  @if (provider.isEditing) {
                    <input type="password" pInputText [(ngModel)]="provider.password" placeholder="Enter password"/>
                  } @else {
                    <span class="detail-value password-hidden">********</span>
                  }
                </div>

                <div class="detail-item detail-item-wide">
                  <label class="detail-label">
                    <i class="pi pi-envelope"></i>
                    From Address
                  </label>
                  @if (provider.isEditing) {
                    <input type="email" pInputText [(ngModel)]="provider.fromAddress" placeholder="noreply@example.com"/>
                  } @else {
                    <span class="detail-value">{{ provider.fromAddress }}</span>
                  }
                </div>
              </div>

              <div class="toggle-options">
                <div class="toggle-item">
                  <p-checkbox
                    [(ngModel)]="provider.auth"
                    [binary]="true"
                    [disabled]="!provider.isEditing"
                    inputId="auth-{{provider.id}}">
                  </p-checkbox>
                  <label [for]="'auth-' + provider.id" class="toggle-label">Authentication</label>
                </div>

                <div class="toggle-item">
                  <p-checkbox
                    [(ngModel)]="provider.startTls"
                    [binary]="true"
                    [disabled]="!provider.isEditing"
                    inputId="starttls-{{provider.id}}">
                  </p-checkbox>
                  <label [for]="'starttls-' + provider.id" class="toggle-label">StartTLS</label>
                </div>

                @if (isAdmin) {
                  <div class="toggle-item">
                    <p-checkbox
                      [(ngModel)]="provider.shared"
                      [binary]="true"
                      (onChange)="toggleShared(provider)"
                      inputId="shared-{{provider.id}}"
                      pTooltip="Share this provider with all users">
                    </p-checkbox>
                    <label [for]="'shared-' + provider.id" class="toggle-label">Shared</label>
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>
