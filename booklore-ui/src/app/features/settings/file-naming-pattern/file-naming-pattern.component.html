<div class="file-naming-container">
  <div class="settings-header">
    <h2 class="settings-title">
      <i class="pi pi-file"></i>
      File Naming Patterns
      <app-external-doc-link docType="fileNamePatterns"></app-external-doc-link>
    </h2>
    <p class="settings-description">
      Configure automatic file organization using metadata placeholders. Patterns are applied when uploading, moving files, or after metadata updates.
    </p>
  </div>

  <div class="warning-notice">
    <i class="pi pi-exclamation-triangle"></i>
    <div>
      <strong>Metadata Quality Notice:</strong> File naming relies entirely on metadata stored in Booklore.
      This feature is recommended only for high-quality, curated libraries with complete metadata.
    </div>
  </div>

  <div class="settings-card">
    <div class="section-header">
      <h3 class="section-title">
        <i class="pi pi-bolt"></i>
        Default Pattern
      </h3>
      <p class="section-description">Fallback pattern when no library-specific override is configured.</p>
    </div>

    <div class="section-body">
      <div class="default-pattern-card">
        <div class="pattern-input-container">
          <div class="pattern-input-row">
            <input
              pInputText
              id="defaultPattern"
              [(ngModel)]="defaultPattern"
              placeholder="e.g., {title} - {authors}"
              (input)="onDefaultPatternChange(defaultPattern)"
              class="pattern-input"/>
            <p-button
              label="Save"
              icon="pi pi-save"
              (onClick)="savePatterns()"
              severity="success"
              [outlined]="true"
              [disabled]="!!defaultErrorMessage">
            </p-button>
          </div>
          @if (defaultErrorMessage) {
            <span class="error-text">{{ defaultErrorMessage }}</span>
          }
          <div class="preview-row">
            <span class="preview-label">
              <i class="pi pi-eye"></i>
              Preview:
            </span>
            <code class="preview-value">{{ generateDefaultPreview() }}</code>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="settings-card">
    <div class="section-header">
      <h3 class="section-title">
        <i class="pi pi-folder"></i>
        Library Overrides
      </h3>
      <p class="section-description">
        Define custom patterns for specific libraries. Leave empty to use the default pattern.
      </p>
    </div>

    <div class="section-body">
      @if (libraries.length === 0) {
        <div class="empty-state">
          <i class="pi pi-folder-open"></i>
          <p class="empty-title">No libraries found</p>
          <p class="empty-subtitle">Create a library to configure custom naming patterns</p>
        </div>
      } @else {
        <div class="libraries-list">
          @for (library of libraries; track library.id) {
            <div class="library-item" [class.has-pattern]="library.fileNamingPattern">
              <div class="library-header">
                <div class="library-info">
                  <div class="library-icon">
                    <i [class]="'pi pi-' + library.icon"></i>
                  </div>
                  <span class="library-name">{{ library.name }}</span>
                  @if (library.fileNamingPattern) {
                    <span class="custom-badge">Custom</span>
                  } @else {
                    <span class="default-badge">Using Default</span>
                  }
                </div>
                <p-button
                  icon="pi pi-times"
                  severity="secondary"
                  size="small"
                  [outlined]="true"
                  [rounded]="true"
                  (onClick)="clearLibraryPattern(library)"
                  [disabled]="!library.fileNamingPattern"
                  pTooltip="Clear pattern">
                </p-button>
              </div>
              <div class="library-body">
                <div class="pattern-input-container">
                  <input
                    pInputText
                    [(ngModel)]="library.fileNamingPattern"
                    placeholder="Leave empty to use default pattern"
                    (input)="onLibraryPatternChange(library)"
                    class="pattern-input"/>
                  <div class="preview-row">
                    <span class="preview-label">
                      <i class="pi pi-eye"></i>
                      Preview:
                    </span>
                    <code class="preview-value">{{ generateLibraryPreview(library) }}</code>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>

        <div class="actions-row">
          <p-button
            label="Save All"
            (onClick)="saveLibraryPatterns()"
            severity="success"
            icon="pi pi-save"
            [outlined]="true">
          </p-button>
        </div>
      }
    </div>
  </div>

  <div class="settings-card">
    <div class="section-header">
      <h3 class="section-title">
        <i class="pi pi-info-circle"></i>
        Placeholders Reference
      </h3>
      <p class="section-description">
        Use placeholders to dynamically insert metadata into file names and folder paths.
      </p>
    </div>

    <div class="section-body">
      <div class="placeholders-grid">
        <div class="placeholder-group">
          <h4 class="group-title">
            <i class="pi pi-hashtag"></i>
            Available Placeholders
          </h4>
          <div class="placeholder-list">
            <div class="placeholder-item"><code>{{ '{title}' }}</code><span>Book title</span></div>
            <div class="placeholder-item"><code>{{ '{subtitle}' }}</code><span>Book subtitle</span></div>
            <div class="placeholder-item"><code>{{ '{authors}' }}</code><span>Author(s)</span></div>
            <div class="placeholder-item"><code>{{ '{year}' }}</code><span>Publication year</span></div>
            <div class="placeholder-item"><code>{{ '{series}' }}</code><span>Series name</span></div>
            <div class="placeholder-item"><code>{{ '{seriesIndex}' }}</code><span>Series index</span></div>
            <div class="placeholder-item"><code>{{ '{language}' }}</code><span>Language code</span></div>
            <div class="placeholder-item"><code>{{ '{publisher}' }}</code><span>Publisher</span></div>
            <div class="placeholder-item"><code>{{ '{isbn}' }}</code><span>ISBN number</span></div>
            <div class="placeholder-item"><code>{{ '{currentFilename}' }}</code><span>Original filename</span></div>
          </div>
        </div>

        <div class="placeholder-group">
          <h4 class="group-title">
            <i class="pi pi-code"></i>
            Optional Blocks
          </h4>
          <p class="group-description">
            Wrap parts in angle brackets <code>{{ '{<...>}' }}</code> to make them conditional.
            If any placeholder in the block has no value, the entire block is omitted.
          </p>
          <div class="example-block">
            <div class="example-pattern">
              <span class="pattern-prefix">Pattern:</span>
              <code>{{ '{<{seriesIndex} - >{title}' }}</code>
            </div>
            <div class="example-results">
              <div class="result-item">
                <span class="result-prefix">With index:</span>
                <code>01 - Dune</code>
              </div>
              <div class="result-item">
                <span class="result-prefix">Without:</span>
                <code>Dune</code>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="settings-card">
    <div class="section-header">
      <h3 class="section-title">
        <i class="pi pi-eye"></i>
        Pattern Examples
      </h3>
      <p class="section-description">
        Sample patterns with example metadata to help you understand how patterns work.
      </p>
    </div>

    <div class="section-body">
      <div class="examples-container">
        <div class="example-category">
          <div class="category-header">
            <h4 class="category-title">
              <i class="pi pi-check-circle"></i>
              With Full Metadata
            </h4>
            <div class="sample-metadata">
              <div class="metadata-items">
                <span><strong>title:</strong> <code>The Name of the Wind</code></span>
                <span><strong>subtitle:</strong> <code>Special Edition</code></span>
                <span><strong>authors:</strong> <code>Patrick Rothfuss</code></span>
                <span><strong>series:</strong> <code>The Kingkiller Chronicle</code></span>
                <span><strong>seriesIndex:</strong> <code>01</code></span>
                <span><strong>year:</strong> <code>2007</code></span>
              </div>
            </div>
          </div>

          <div class="example-grid">
            <div class="example-row">
              <span class="pattern-label">Basic pattern</span>
              <span class="pattern-col"><code>{{ '{authors} - {title}' }}</code></span>
              <span class="result-col"><code>Patrick Rothfuss - The Name of the Wind.epub</code></span>
            </div>
            <div class="example-row">
              <span class="pattern-label">With punctuation</span>
              <span class="pattern-col"><code>{{ '{title}: {series}' }}</code></span>
              <span class="result-col"><code>The Name of the Wind: The Kingkiller Chronicle.epub</code></span>
            </div>
            <div class="example-row">
              <span class="pattern-label">Series in folder</span>
              <span class="pattern-col"><code>{{ '{authors}/{series}/{seriesIndex} - {title}' }}</code></span>
              <span class="result-col"><code>Patrick Rothfuss/The Kingkiller Chronicle/01 - The Name of the Wind.epub</code></span>
            </div>
            <div class="example-row">
              <span class="pattern-label">Folder only</span>
              <span class="pattern-col"><code>{{ '{title}/' }}</code></span>
              <span class="result-col"><code>The Name of the Wind/name_of_the_wind_original.epub</code></span>
            </div>
            <div class="example-row">
              <span class="pattern-label">Absolute path</span>
              <span class="pattern-col"><code>{{ '/{authors}/{title}' }}</code></span>
              <span class="result-col"><code>/Patrick Rothfuss/The Name of the Wind.epub</code></span>
            </div>
            <div class="example-row">
              <span class="pattern-label">Title + Subtitle</span>
              <span class="pattern-col"><code>{{ '{title}: {subtitle}' }}</code></span>
              <span class="result-col"><code>The Name of the Wind: Special Edition.epub</code></span>
            </div>
          </div>
        </div>

        <div class="section-divider"><hr></div>

        <div class="example-category">
          <div class="category-header">
            <h4 class="category-title">
              <i class="pi pi-question-circle"></i>
              With Missing Optional Fields
            </h4>
            <div class="sample-metadata">
              <div class="metadata-items">
                <span><strong>title:</strong> <code>Project Hail Mary</code></span>
                <span><strong>subtitle:</strong> <em class="not-set">not set</em></span>
                <span><strong>authors:</strong> <code>Andy Weir</code></span>
                <span><strong>year:</strong> <code>2021</code></span>
                <span><strong>series:</strong> <em class="not-set">not set</em></span>
                <span><strong>seriesIndex:</strong> <em class="not-set">not set</em></span>
              </div>
            </div>
          </div>

          <div class="example-grid">
            <div class="example-row">
              <span class="pattern-label">Optional blocks</span>
              <span class="pattern-col"><code>{{ '{authors}/<{series}/><{seriesIndex}. >{title}< ({year})>' }}</code></span>
              <span class="result-col"><code>Andy Weir/Project Hail Mary (2021).epub</code></span>
            </div>
            <div class="example-row">
              <span class="pattern-label">SeriesIndex fallback</span>
              <span class="pattern-col"><code>{{ '<{seriesIndex}. >{title}< - {authors}>' }}</code></span>
              <span class="result-col"><code>Project Hail Mary - Andy Weir.epub</code></span>
            </div>
            <div class="example-row">
              <span class="pattern-label">Brackets fallback</span>
              <span class="pattern-col"><code>{{ '<[{series}] >{title} - {authors}' }}</code></span>
              <span class="result-col"><code>Project Hail Mary - Andy Weir.epub</code></span>
            </div>
            <div class="example-row">
              <span class="pattern-label">Series punctuation</span>
              <span class="pattern-col"><code>{{ '<{series}: >{title} by {authors}' }}</code></span>
              <span class="result-col"><code>Project Hail Mary by Andy Weir.epub</code></span>
            </div>
            <div class="example-row">
              <span class="pattern-label">Year prefix</span>
              <span class="pattern-col"><code>{{ '{authors}/{year}__{currentFilename}' }}</code></span>
              <span class="result-col"><code>Andy Weir/2021__project_hail_mary_final.epub</code></span>
            </div>
            <div class="example-row">
              <span class="pattern-label">Subtitle fallback</span>
              <span class="pattern-col"><code>{{ '{title}<: {subtitle}>' }}</code></span>
              <span class="result-col"><code>Project Hail Mary.epub</code></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
